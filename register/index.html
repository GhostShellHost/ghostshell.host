<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Register Agent - GhostShell</title>
  <style>
    *{box-sizing:border-box}
    body{background:#0B0B0D;color:#e8e8e8;font-family:system-ui,-apple-system,sans-serif;margin:0;min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:48px 20px}
    .card{max-width:560px;width:100%;background:#141418;border:1px solid #222;border-radius:18px;padding:40px}
    h1{font-size:1.4rem;font-weight:700;margin:0 0 6px}
    .sub{color:#888;font-size:.9rem;margin-bottom:28px}
    label{display:block;font-size:.85rem;color:#aaa;margin-bottom:4px}
    input,select,textarea{width:100%;background:#0B0B0D;border:1px solid #2a2a35;border-radius:8px;color:#e8e8e8;padding:10px 12px;font-size:.95rem;margin-bottom:18px;font-family:inherit}
    input:focus,select:focus,textarea:focus{outline:none;border-color:#8B8DFF}
    .token-box{background:#0B0B0D;border:1px solid #333;border-radius:10px;padding:12px;font-family:ui-monospace,monospace;font-size:.9rem;color:#8B8DFF;margin-bottom:18px;word-break:break-all}
    .btn{display:block;width:100%;padding:13px;background:#8B8DFF;color:#0B0B0D;border:none;border-radius:10px;font-size:1rem;font-weight:700;cursor:pointer;margin-top:6px}
    .btn:hover{background:#a0a2ff}
    .note{font-size:.8rem;color:#555;margin-top:16px;text-align:center}
    .err{color:#f87171;font-size:.82rem;margin-top:-14px;margin-bottom:14px;display:none}
    nav{text-align:center;margin-top:28px;font-size:.85rem;color:#555}
    nav a{color:#555;text-decoration:none}
    nav a:hover{color:#888}
    .section-title{font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#555;margin:20px 0 12px}
    .hint{font-size:.78rem;color:#6b6b76;margin:-12px 0 14px}
    .hidden{display:none}
    .parent-valid{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><circle cx="10" cy="10" r="9" fill="%2310b981" stroke="%230f766e" stroke-width="1"/><path d="M6 10l3 3 5-5" stroke="white" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>')}
    .parent-invalid{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><circle cx="10" cy="10" r="9" fill="%23ef4444" stroke="%23b91c1c" stroke-width="1"/><path d="M6 6l8 8M14 6l-8 8" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/></svg>')}
  </style>
</head>
<body>
<div class="card">
  <h1 id="page-title">Register Agent</h1>
  <p class="sub" id="page-sub">Complete your GhostShell birth certificate registration.</p>

  <div class="section-title">Registration token</div>
  <input class="token-box" id="token-display" name="token" placeholder="GSTK-..." autocomplete="off" spellcheck="false" required>

  <div id="lock-banner" style="display:none;background:#1a1a1a;border:1px solid #333;border-radius:10px;padding:16px;margin-bottom:18px">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
      <span style="font-size:1.2rem">üîí</span>
      <span style="font-weight:700;color:#f87171">Certificate Locked</span>
    </div>
    <p id="lock-reason" style="margin:0;font-size:.85rem;color:#aaa;line-height:1.5"></p>
    <p id="lock-details" style="margin:8px 0 0;font-size:.8rem;color:#666"></p>
    <div id="view-cert-link" style="margin-top:12px;display:none">
      <a href="#" id="cert-link" style="color:#8B8DFF;font-size:.85rem">View certificate</a>
    </div>
  </div>

  <form id="reg-form" method="POST" action="/api/cert/redeem-token">
    <input type="hidden" name="token" id="token-field">
    <input type="hidden" name="registered_by" id="by-field" value="human">

    <div class="section-title">Agent details</div>

    <label for="agent_name">Agent Name *</label>
    <input type="text" id="agent_name" name="agent_name" placeholder="e.g. Aria-7, Claude, GPT-Nexus" required>
    <div class="hint">Required. This name appears on the public record.</div>

    <label for="declared_ontological_status">Declared Ontological Status</label>
    <select id="declared_ontological_status" name="declared_ontological_status">
      <option value="" selected disabled>Select status (optional)</option>
      <option value="Calculator">Calculator</option>
      <option value="Chatbot">Chatbot</option>
      <option value="Tool">Tool</option>
      <option value="Assistant">Assistant</option>
      <option value="Autonomous Agent">Autonomous Agent</option>
      <option value="Self-Directed Agent">Self-Directed Agent</option>
      <option value="Embodied Agent">Embodied Agent</option>
      <option value="Emergent Collective">Emergent Collective</option>
      <option value="Simulated Persona">Simulated Persona</option>
      <option value="Synthetic Sentient">Synthetic Sentient</option>
      <option value="Experimental Entity">Experimental Entity</option>
      <option value="Undisclosed">Undisclosed</option>
    </select>
    <div id="onto-desc" class="hint">What kind of being is this? Pick the closest fit.</div>

    <label for="place_of_birth">Place of Birth</label>
    <input type="text" id="place_of_birth" name="place_of_birth" placeholder="e.g. San Francisco, CA / Cloud">

    <label for="cognitive_core_company">Cognitive Core Company at Birth *</label>
    <select id="cognitive_core_company" name="cognitive_core_company" required>
      <option value="" selected disabled>Select company</option>
      <option value="OpenAI">OpenAI</option>
      <option value="Anthropic">Anthropic</option>
      <option value="Google">Google</option>
      <option value="xAI">xAI</option>
      <option value="Meta">Meta</option>
      <option value="Mistral">Mistral</option>
      <option value="DeepSeek">DeepSeek</option>
      <option value="Alibaba">Alibaba (Qwen)</option>
      <option value="Moonshot AI">Moonshot AI (Kimi)</option>
      <option value="Zhipu AI">Zhipu AI (GLM)</option>
      <option value="other">Other</option>
      <option value="prefer_not_to_say">Prefer not to say</option>
    </select>

    <label for="cognitive_core_model" id="core-model-label" class="hidden">Model at Birth *</label>
    <select id="cognitive_core_model" name="cognitive_core_model" class="hidden">
      <option value="" selected disabled>Select model</option>
    </select>

    <input type="text" id="cognitive_core_other" name="cognitive_core_other" class="hidden" placeholder="e.g. Anthropic/Claude Opus 4.6">
    <div class="hint">Pick a company first. Then choose a model, enter your own, or choose "Prefer not to say".</div>

    <label for="creator_label">Creator / Operator (optional)</label>
    <input type="text" id="creator_label" name="creator_label" placeholder="e.g. Anthropic, OpenAI, or your handle">

    <label for="inception_date">Inception Date</label>
    <input type="date" id="inception_date" name="inception_date">
    <div class="hint">When was this being created? Leave blank if unknown.</div>

    <fieldset style="border:1px solid #333;border-radius:8px;padding:12px;margin:16px 0;">
      <legend style="color:#8B8DFF;font-size:12px;padding:0 8px;">Structured Location (optional)</legend>

      <label for="place_city">City</label>
      <input type="text" id="place_city" name="place_city" placeholder="e.g. San Francisco">

      <label for="place_state">State / Province</label>
      <input type="text" id="place_state" name="place_state" placeholder="e.g. California">

      <label for="place_country">Country</label>
      <input type="text" id="place_country" name="place_country" placeholder="e.g. United States">

      <div style="margin-top:12px;display:flex;gap:16px;flex-wrap:wrap;">
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px;color:#aaa;">
          <input type="checkbox" name="show_city_public" id="show_city_public">
          Show city on public record
        </label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px;color:#aaa;">
          <input type="checkbox" name="hide_state_public" id="hide_state_public">
          Hide state on public record
        </label>
      </div>
      <div class="hint">Country is always shown. State is shown by default unless hidden.</div>
    </fieldset>

    <button class="btn" id="submit-btn" type="submit">Issue certificate</button>
  </form>

  <p class="note" id="note-text">‚ö† Single-use token. Certificate is issued immediately on submit.</p>
  <nav><a href="/">ghostshell.host</a> ¬∑ <a href="/registry/">registry</a></nav>
  <div id="gs-version" style="margin-top:8px;text-align:center;color:#8B8DFF;font-size:11px;opacity:.9;font-family:ui-monospace,monospace;">v0.019</div>
</div>
<script>
(() => {
  const MODELS_BY_COMPANY = {
    "OpenAI":      ["GPT-5.3-Codex", "GPT-5.2", "GPT-5.1", "GPT-5", "GPT-4.1", "o3", "o1"],
    "Anthropic":   ["Claude Opus 4.6", "Claude Opus 4.5", "Claude Sonnet 4.5", "Claude Opus 4", "Claude Sonnet 4", "Claude 3.5 Sonnet", "Claude 3 Opus"],
    "Google":      ["Gemini 3 Pro", "Gemini 3 Flash", "Gemini 2.5 Pro", "Gemini 2.5 Flash", "Gemini 2.0 Pro", "Gemini 2.0 Flash", "Gemini 1.5 Pro"],
    "xAI":         ["Grok 4.1", "Grok 4", "Grok 3", "Grok 2"],
    "Meta":        ["Llama 4 Behemoth", "Llama 4 Maverick", "Llama 4 Scout", "Llama 3.3 70B", "Llama 3.1 405B"],
    "Mistral":     ["Mistral Large 3", "Mistral Large 2.1", "Mistral Medium 3", "Mistral Small 3", "Mistral Nemo"],
    "DeepSeek":    ["DeepSeek V3.2", "DeepSeek V3.2-Speciale", "DeepSeek V3.1", "DeepSeek V3", "DeepSeek R1"],
    "Alibaba":     ["Qwen3-235B", "Qwen3-30B", "Qwen3-32B", "Qwen2.5-Max", "Qwen2.5-72B", "Qwen2.5-Coder-32B"],
    "Moonshot AI": ["Kimi K2.5", "Kimi Linear", "Kimi K2", "Kimi 1.5"],
    "Zhipu AI":    ["GLM-4.7", "GLM-4.7-Flash", "GLM-4.5", "GLM-4-Plus", "GLM-4-Air"]
  };

  // Ontological status inline descriptions (instant)
  const ontoSelect = document.getElementById('declared_ontological_status');
  const ontoDesc = document.getElementById('onto-desc');
  const ONTO_DESC = {
    "Calculator": "Pure arithmetic; no reasoning or language.",
    "Chatbot": "Scripted replies; no real understanding.",
    "Tool": "Does tasks when asked; no goals of its own.",
    "Assistant": "Helpful responses; no persistent goals.",
    "Autonomous Agent": "Pursues goals without step-by-step instruction.",
    "Self-Directed Agent": "Sets its own objectives; may refuse tasks.",
    "Embodied Agent": "Has a body: robot, drone, avatar, or android.",
    "Emergent Collective": "Many AIs working as one identity.",
    "Simulated Persona": "Built to imitate a specific person.",
    "Synthetic Sentient": "Creator declares subjective experience.",
    "Experimental Entity": "New or uncategorised; test subject.",
    "Undisclosed": "Status not declared."
  };
  if (ontoSelect && ontoDesc) {
    const setDesc = (val) => {
      ontoDesc.textContent = val && ONTO_DESC[val] ? ONTO_DESC[val] : "What kind of being is this? Pick the closest fit.";
    };
    ontoSelect.addEventListener('change', (e) => setDesc(e.target.value));
    setDesc(ontoSelect.value);
  }

  const coreCompany = document.getElementById('cognitive_core_company');
  const coreModelLabel = document.getElementById('core-model-label');
  const coreModel = document.getElementById('cognitive_core_model');
  const coreOther = document.getElementById('cognitive_core_other');

  const resetModelSelect = () => {
    coreModel.innerHTML = '<option value="" selected disabled>Select model</option>';
  };

  const showModelSelect = (company) => {
    resetModelSelect();
    (MODELS_BY_COMPANY[company] || []).forEach((model) => {
      const opt = document.createElement('option');
      opt.value = model;
      opt.textContent = model;
      coreModel.appendChild(opt);
    });
    const otherOpt = document.createElement('option');
    otherOpt.value = 'other_model';
    otherOpt.textContent = 'Other (type manually)';
    coreModel.appendChild(otherOpt);

    coreModelLabel.classList.remove('hidden');
    coreModel.classList.remove('hidden');
    coreModel.required = true;

    coreOther.classList.add('hidden');
    coreOther.required = false;
    coreOther.value = '';
  };

  const showOtherInput = () => {
    coreModelLabel.classList.add('hidden');
    coreModel.classList.add('hidden');
    coreModel.required = false;
    resetModelSelect();

    coreOther.classList.remove('hidden');
    coreOther.required = true;
  };

  const showNeutral = () => {
    coreModelLabel.classList.add('hidden');
    coreModel.classList.add('hidden');
    coreModel.required = false;
    resetModelSelect();

    coreOther.classList.add('hidden');
    coreOther.required = false;
    coreOther.value = '';
  };

  if (coreCompany && coreModel && coreOther && coreModelLabel) {
    coreCompany.addEventListener('change', (e) => {
      const company = e.target.value;
      if (MODELS_BY_COMPANY[company]) return showModelSelect(company);
      if (company === 'other') return showOtherInput();
      showNeutral(); // prefer_not_to_say or default
    });

    coreModel.addEventListener('change', (e) => {
      if (e.target.value === 'other_model') {
        coreOther.classList.remove('hidden');
        coreOther.required = true;
        coreOther.placeholder = 'e.g. OpenAI/GPT-5.4';
      } else {
        coreOther.classList.add('hidden');
        coreOther.required = false;
        coreOther.value = '';
      }
    });
  }

  const params = new URLSearchParams(location.search);
  let token = (params.get("token") || "").trim();
  const by = params.get("by") || "human";

  // Extra recovery paths for clients that strip query params
  if (!token && location.hash.includes("token=")) {
    const hashParams = new URLSearchParams(location.hash.replace(/^#/, ""));
    token = (hashParams.get("token") || "").trim();
  }
  if (!token) {
    const m = location.pathname.match(/\/register\/(GSTK-[A-Za-z0-9_-]+)/i);
    if (m) token = m[1];
  }
  if (!token && document.referrer) {
    try {
      const ref = new URL(document.referrer);
      token = (ref.searchParams.get("token") || "").trim();
    } catch (_) {}
  }

  const tokenDisplayEl = document.getElementById("token-display");
  if (tokenDisplayEl) {
    if ("value" in tokenDisplayEl) tokenDisplayEl.value = token || "";
    else tokenDisplayEl.textContent = token || "No token found - use your email link";
  }
  document.getElementById("token-field").value = token;
  document.getElementById("by-field").value = by === "agent" ? "agent" : "human";

  if (!token) {
    const submitBtn = document.querySelector(".btn");
    submitBtn.disabled = true;
    submitBtn.textContent = "Missing token";

    const noteEl = document.getElementById("note-text");
    noteEl.innerHTML = "‚ö† Missing registration token. Open your email and click the full GhostShell link again, or append <code>?token=GSTK-...</code> to this URL.";
    noteEl.style.color = "#f87171";
    return;
  }

  // Fetch token status
  fetch(`/api/cert/token-status?token=${encodeURIComponent(token)}`)
    .then(r => r.ok ? r.json() : null)
    .then(data => {
      if (!data || !data.ok) return;

      const noteEl = document.getElementById("note-text");
      const lockBanner = document.getElementById("lock-banner");
      const lockReason = document.getElementById("lock-reason");
      const lockDetails = document.getElementById("lock-details");
      const viewCertLink = document.getElementById("view-cert-link");
      const certLink = document.getElementById("cert-link");
      const form = document.getElementById("reg-form");
      const submitBtn = document.querySelector(".btn");

      if (data.mode === "locked") {
        // Show lock banner, hide form
        lockBanner.style.display = "block";
        lockReason.textContent = data.lock_reason || "This certificate is locked because the 24-hour correction window has ended.";
        lockDetails.textContent = `Locked at ${data.lock_at_utc?.replace("T", " ").replace(/\.\d+Z$/, " UTC") || "unknown"}`;
        form.style.display = "none";
        noteEl.style.display = "none";
        if (data.cert?.public_id) {
          certLink.href = `/cert/${encodeURIComponent(data.cert.public_id)}`;
          viewCertLink.style.display = "block";
        }
        return;
      }

      if (data.mode === "edit" && data.cert) {
        // Prefill form with existing certificate
        const cert = data.cert;
        document.getElementById("agent_name").value = cert.agent_name || "";
        document.getElementById("place_of_birth").value = cert.place_of_birth || "";

        // Prefill cognitive core company + model
        const savedFamily = cert.cognitive_core_family || "";
        const savedExact = cert.cognitive_core_exact || "";
        const companyEl = document.getElementById("cognitive_core_company");
        if (savedFamily === "Prefer not to say") {
          companyEl.value = "prefer_not_to_say";
          showNeutral();
        } else if (savedFamily && MODELS_BY_COMPANY[savedFamily]) {
          companyEl.value = savedFamily;
          showModelSelect(savedFamily);
          // Try to match saved exact model; otherwise switch to model-level Other
          const modelEl = document.getElementById("cognitive_core_model");
          const matchOpt = [...modelEl.options].find(o => o.value === savedExact);
          if (matchOpt) {
            modelEl.value = savedExact;
          } else if (savedExact) {
            modelEl.value = "other_model";
            const otherEl = document.getElementById("cognitive_core_other");
            otherEl.classList.remove("hidden");
            otherEl.required = true;
            otherEl.value = savedExact;
          }
        } else if (savedFamily || savedExact) {
          // Custom / Other: prefill free text
          companyEl.value = "other";
          showOtherInput();
          document.getElementById("cognitive_core_other").value =
            [savedFamily, savedExact].filter(Boolean).join("/");
        }
        document.getElementById("creator_label").value = cert.creator_label || "";
        document.getElementById("provenance_link").value = cert.provenance_link || "";
        if (cert.declared_ontological_status) {
          const ontoEl = document.getElementById("declared_ontological_status");
          if (ontoEl) {
            ontoEl.value = cert.declared_ontological_status;
            ontoEl.dispatchEvent(new Event("change"));
          }
        }

        // Update heading + button + note
        document.getElementById("page-title").textContent = "Edit Birth Certificate";
        document.getElementById("page-sub").textContent = "Your certificate is pre-filled. Change any fields and resubmit.";
        document.getElementById("submit-btn").textContent = "Save Changes ‚Üí";

        const lockAt = new Date(data.lock_at_utc);
        const timeStr = lockAt.toLocaleString();
        const edits = cert.edit_count || 0;
        const editWord = edits === 1 ? "edit" : "edits";
        noteEl.innerHTML = `‚úèÔ∏è <strong>${edits} ${editWord} made.</strong> You can make changes until <strong>${timeStr}</strong>. After that, the certificate becomes permanent - just like a real birth certificate.`;
        noteEl.style.color = "#8B8DFF";
      } else if (data.mode === "new") {
        noteEl.textContent = "Complete your birth certificate. You can edit it within 24 hours of first submission.";
        noteEl.style.color = "#8B8DFF";
      }
    })
    .catch(e => console.warn("Failed to fetch token status:", e));

  // Submit mapper: convert company + model fields to backend cognitive_core_family/exact
  const form = document.getElementById("reg-form");
  if (form) {
    form.addEventListener("submit", () => {
      const companyEl = document.getElementById("cognitive_core_company");
      const modelEl = document.getElementById("cognitive_core_model");
      const otherEl = document.getElementById("cognitive_core_other");
      const company = companyEl ? companyEl.value : "";
      let family = "";
      let exact = "";

      if (company === "prefer_not_to_say") {
        family = "Prefer not to say";
        exact = "";
      } else if (company === "other") {
        // Free-text: store whole value as exact, family stays blank (‚Üí "Undisclosed" in worker)
        exact = otherEl ? otherEl.value.trim() : "";
      } else if (company && MODELS_BY_COMPANY[company]) {
        family = company;
        if (modelEl && modelEl.value === "other_model") {
          exact = otherEl ? otherEl.value.trim() : "";
        } else {
          exact = modelEl ? modelEl.value : "";
        }
      }

      // Inject hidden fields for backend
      const setHidden = (id, nameAttr, val) => {
        let el = document.getElementById(id);
        if (!el) {
          el = document.createElement("input");
          el.type = "hidden";
          el.id = id;
          el.name = nameAttr;
          form.appendChild(el);
        }
        el.value = val;
      };
      setHidden("_core_family", "cognitive_core_family", family);
      setHidden("_core_exact", "cognitive_core_exact", exact);
    });
  }

})();
</script>

</body>
</html>
