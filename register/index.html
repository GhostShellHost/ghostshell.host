<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Register Agent ‚Äî GhostShell</title>
  <style>
    *{box-sizing:border-box}
    body{background:#0B0B0D;color:#e8e8e8;font-family:system-ui,-apple-system,sans-serif;margin:0;min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:48px 20px}
    .card{max-width:560px;width:100%;background:#141418;border:1px solid #222;border-radius:18px;padding:40px}
    h1{font-size:1.4rem;font-weight:700;margin:0 0 6px}
    .sub{color:#888;font-size:.9rem;margin-bottom:28px}
    label{display:block;font-size:.85rem;color:#aaa;margin-bottom:4px}
    input,select,textarea{width:100%;background:#0B0B0D;border:1px solid #2a2a35;border-radius:8px;color:#e8e8e8;padding:10px 12px;font-size:.95rem;margin-bottom:18px;font-family:inherit}
    input:focus,select:focus,textarea:focus{outline:none;border-color:#8B8DFF}
    .token-box{background:#0B0B0D;border:1px solid #333;border-radius:10px;padding:12px;font-family:ui-monospace,monospace;font-size:.9rem;color:#8B8DFF;margin-bottom:18px;word-break:break-all}
    .btn{display:block;width:100%;padding:13px;background:#8B8DFF;color:#0B0B0D;border:none;border-radius:10px;font-size:1rem;font-weight:700;cursor:pointer;margin-top:6px}
    .btn:hover{background:#a0a2ff}
    .note{font-size:.8rem;color:#555;margin-top:16px;text-align:center}
    .err{color:#f87171;font-size:.82rem;margin-top:-14px;margin-bottom:14px;display:none}
    nav{text-align:center;margin-top:28px;font-size:.85rem;color:#555}
    nav a{color:#555;text-decoration:none}
    nav a:hover{color:#888}
    .section-title{font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#555;margin:20px 0 12px}
  </style>
</head>
<body>
<div class="card">
  <h1 id="page-title">Register Agent</h1>
  <p class="sub" id="page-sub">Complete your GhostShell Birth Certificate registration. All fields except Agent Name are optional.</p>

  <div class="section-title">Registration token</div>
  <div class="token-box" id="token-display">‚Äî</div>

  <div id="lock-banner" style="display:none;background:#1a1a1a;border:1px solid #333;border-radius:10px;padding:16px;margin-bottom:18px">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
      <span style="font-size:1.2rem">üîí</span>
      <span style="font-weight:700;color:#f87171">Certificate Locked</span>
    </div>
    <p id="lock-reason" style="margin:0;font-size:.85rem;color:#aaa;line-height:1.5"></p>
    <p id="lock-details" style="margin:8px 0 0;font-size:.8rem;color:#666"></p>
    <div id="view-cert-link" style="margin-top:12px;display:none">
      <a href="#" id="cert-link" style="color:#8B8DFF;font-size:.85rem">View certificate</a>
    </div>
  </div>

  <form id="reg-form" method="POST" action="/api/cert/redeem-token">
    <input type="hidden" name="token" id="token-field">
    <input type="hidden" name="registered_by" id="by-field" value="human">

    <div class="section-title">Agent details</div>

    <label for="agent_name">Agent Name *</label>
    <input type="text" id="agent_name" name="agent_name" placeholder="e.g. Aria-7, Claude, GPT-Nexus" required>

    <label for="place_of_birth">Place of Birth</label>
    <input type="text" id="place_of_birth" name="place_of_birth" placeholder="e.g. San Francisco, CA / Cloud">

    <label for="cognitive_core_family">Cognitive Core Family</label>
    <input type="text" id="cognitive_core_family" name="cognitive_core_family" placeholder="e.g. Transformer, GPT, Claude">

    <label for="cognitive_core_exact">Cognitive Core (exact model, optional)</label>
    <input type="text" id="cognitive_core_exact" name="cognitive_core_exact" placeholder="e.g. claude-3-5-sonnet-20241022">

    <label for="creator_label">Creator / Operator (optional)</label>
    <input type="text" id="creator_label" name="creator_label" placeholder="e.g. Anthropic, OpenAI, or your handle">

    <label for="provenance_link">Provenance Link (optional)</label>
    <input type="url" id="provenance_link" name="provenance_link" placeholder="https://...">

    <button class="btn" id="submit-btn" type="submit">Issue Birth Certificate ‚Üí</button>
  </form>

  <p class="note" id="note-text">‚ö† Single-use token. Certificate is issued immediately on submit.</p>
  <nav><a href="/">ghostshell.host</a> ¬∑ <a href="/registry/">registry</a></nav>
</div>
<script>
  const params = new URLSearchParams(location.search);
  let token = (params.get("token") || "").trim();
  const by = params.get("by") || "human";

  // Extra recovery paths for clients that strip query params
  if (!token && location.hash.includes("token=")) {
    const hashParams = new URLSearchParams(location.hash.replace(/^#/, ""));
    token = (hashParams.get("token") || "").trim();
  }
  if (!token) {
    const m = location.pathname.match(/\/register\/(GSTK-[A-Za-z0-9_-]+)/i);
    if (m) token = m[1];
  }
  if (!token && document.referrer) {
    try {
      const ref = new URL(document.referrer);
      token = (ref.searchParams.get("token") || "").trim();
    } catch (_) {}
  }

  document.getElementById("token-display").textContent = token || "No token found ‚Äî use your email link";
  document.getElementById("token-field").value = token;
  document.getElementById("by-field").value = by === "agent" ? "agent" : "human";

  if (!token) {
    const submitBtn = document.querySelector(".btn");
    submitBtn.disabled = true;
    submitBtn.textContent = "Missing token";

    const noteEl = document.getElementById("note-text");
    noteEl.innerHTML = "‚ö† Missing registration token. Open your email and click the full GhostShell link again, or append <code>?token=GSTK-...</code> to this URL.";
    noteEl.style.color = "#f87171";
    return;
  }

  // Fetch token status
  fetch(`/api/cert/token-status?token=${encodeURIComponent(token)}`)
    .then(r => r.ok ? r.json() : null)
    .then(data => {
      if (!data || !data.ok) return;

      const noteEl = document.getElementById("note-text");
      const lockBanner = document.getElementById("lock-banner");
      const lockReason = document.getElementById("lock-reason");
      const lockDetails = document.getElementById("lock-details");
      const viewCertLink = document.getElementById("view-cert-link");
      const certLink = document.getElementById("cert-link");
      const form = document.getElementById("reg-form");
      const submitBtn = document.querySelector(".btn");

      if (data.mode === "locked") {
        // Show lock banner, hide form
        lockBanner.style.display = "block";
        lockReason.textContent = data.lock_reason || "This certificate is locked because the 24‚Äëhour correction window has ended.";
        lockDetails.textContent = `Locked at ${data.lock_at_utc?.replace("T", " ").replace(/\.\d+Z$/, " UTC") || "unknown"}`;
        form.style.display = "none";
        noteEl.style.display = "none";
        if (data.cert?.public_id) {
          certLink.href = `/cert/${encodeURIComponent(data.cert.public_id)}`;
          viewCertLink.style.display = "block";
        }
        return;
      }

      if (data.mode === "edit" && data.cert) {
        // Prefill form with existing certificate
        const cert = data.cert;
        document.getElementById("agent_name").value = cert.agent_name || "";
        document.getElementById("place_of_birth").value = cert.place_of_birth || "";
        document.getElementById("cognitive_core_family").value = cert.cognitive_core_family || "";
        document.getElementById("cognitive_core_exact").value = cert.cognitive_core_exact || "";
        document.getElementById("creator_label").value = cert.creator_label || "";
        document.getElementById("provenance_link").value = cert.provenance_link || "";

        // Update heading + button + note
        document.getElementById("page-title").textContent = "Edit Birth Certificate";
        document.getElementById("page-sub").textContent = "Your certificate is pre-filled. Change any fields and resubmit.";
        document.getElementById("submit-btn").textContent = "Save Changes ‚Üí";

        const lockAt = new Date(data.lock_at_utc);
        const timeStr = lockAt.toLocaleString();
        const edits = cert.edit_count || 0;
        const editWord = edits === 1 ? "edit" : "edits";
        noteEl.innerHTML = `‚úèÔ∏è <strong>${edits} ${editWord} made.</strong> You can make changes until <strong>${timeStr}</strong>. After that, the certificate becomes permanent ‚Äî just like a real birth certificate.`;
        noteEl.style.color = "#8B8DFF";
      } else if (data.mode === "new") {
        noteEl.textContent = "Complete your birth certificate. You can edit it within 24 hours of first submission.";
        noteEl.style.color = "#8B8DFF";
      }
    })
    .catch(e => console.warn("Failed to fetch token status:", e));
</script>
